# Razdevalochka Bot

Telegram-бот на базе `aiogram 3` для генерации изображений через API `api.grtkniv.net` с монетизацией в Telegram Stars, CryptoBot и реферальной системой.

## Возможности

- Регистрация пользователей и хранение баланса токенов в базе данных.
- Генерация изображений (раздевание/смена позы) через API `api.grtkniv.net` с отслеживанием статуса задач.
- Пополнение токенов через CryptoBot с проверкой инвойсов и реферальными бонусами.
- Реферальная программа с уникальными ссылками и бонусами за первую покупку и последующие пополнения.
- Управление администраторами через команды `/add_admin`, `/remove_admin`, `/admins`.
- Webhook-сервер на базе `aiohttp` для деплоя на Railway или аналогичных платформах.

## Требования

- Python 3.11+
- Telegram Bot Token
- Токен CryptoBot
- Токен API `api.grtkniv.net`

## Установка и запуск

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

> ⚠️ Библиотека `aiocryptopay` доступна в PyPI только до версии `0.4.8`.
> В `requirements.txt` закреплена именно она, поэтому установка на Railway
> проходит успешно, даже если более новые релизы недоступны. В коде сервис
> оборачивает клиент `AioCryptoPay`, обрабатывая сетевые ошибки и корректно
> закрывая соединения.

Создайте файл `.env` и заполните обязательные переменные:

```env
BOT_TOKEN=...
ADMINS=742200799,1431759600
IMAGE_API_TOKEN=...
CRYPTO_BOT_TOKEN=...
USE_WEBHOOK=true
WEBHOOK_HOST=https://<project>.railway.app
WEBHOOK_SECRET=<secret>
```

Дополнительные настройки см. в `app/config.py` (цены, пакеты токенов, реферальные коэффициенты и т.п.).

Запуск локально (polling) или в продакшене (webhook):

```bash
python -m app.main
```

## Структура проекта

```
app/
  main.py              # запуск webhook-сервера
  config.py            # конфигурация через pydantic-settings
  db.py                # инициализация БД и фабрика сессий
  models.py            # SQLAlchemy модели пользователей, транзакций и задач
  repositories.py      # слой доступа к данным
  handlers/            # обработчики команд и событий
  middlewares/         # middleware (админ, репозитории, антифлуд)
  services/            # интеграции и бизнес-логика (billing, CryptoBot, image API, referral)
  utils/               # логирование
```

## Команды бота

- `/start` — регистрация и приветствие.
- `/buy` — выбор пакета токенов с оплатой через CryptoBot.
- `/ref` — получение реферальной ссылки и статистики.
- `/refstats` — расширенная статистика по рефералам.
- `/add_admin`, `/remove_admin`, `/admins` — управление администраторами (для админов).

Отправка фотографии запускает процесс генерации изображения через API `api.grtkniv.net`. Стоимость — 1 токен. В случае ошибки токен возвращается пользователю.

## Деплой на Railway

1. Создайте проект и подключите репозиторий.
2. Установите переменные окружения из `.env`.
3. Railway автоматически выполнит команду из `Procfile` (`web: python -m app.main`).
4. После первого запуска webhook будет настроен автоматически (`WEBHOOK_HOST` + `WEBHOOK_PATH`).

## Лицензия

Проект распространяется свободно. Используйте и адаптируйте под свои задачи.
