# Telegram Billing Bot

Инфраструктура Telegram-бота на основе `aiogram 3`, реализующая внутренние токены, пополнение через Telegram Stars, ручные заявки и админ-панель.

## Возможности

- Регистрация пользователя по команде `/start`, хранение `chat_id` и `username`.
- Отображение баланса, истории операций и поддержка в главном меню.
- Покупка токенов через Telegram Stars с автоматическим начислением.
- Создание ручных заявок на пополнение (карты РФ/международные/крипта).
- Админ-панель с интерактивным выбором пользователей, быстрыми начислениями токенов, управлением заявками, рассылкой и экспортом CSV.
- Настраиваемые параметры экономики через `.env`.
- Демо сценарий генерации изображений с поэтапным обновлением одного сообщения.
- Структурированное логирование и простая защита от флуд-атак.

## Требования

- Python 3.11+
- Telegram Bot Token

## Быстрый старт (локально)

1. Клонируйте репозиторий и перейдите в каталог проекта.
2. Создайте виртуальное окружение и установите зависимости:

   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   ```

3. Скопируйте `.env.example` в `.env` и заполните значения:

   ```bash
   cp .env.example .env
   ```

   Обязательные параметры:

   - `BOT_TOKEN` — токен бота от @BotFather.
   - `ADMINS` — список ID администраторов через запятую.
   - `LOG_LEVEL` — уровень логирования (например, INFO).
   - `PRICE_BUY_RUB` / `PRICE_SELL_RUB` — справочные цены токенов.
   - `STARS_PACKS` — пакеты токенов для Telegram Stars.

   Дополнительно при работе с интеграциями:

   - `IMAGE_API_TOKEN` — токен сервиса генерации изображений.
   - `IMAGE_WEBHOOK_URL` — webhook для получения статусов генерации (опционально).
   - `CRYPTO_BOT_TOKEN` — токен внешнего криптопровайдера.

   ⚠️ Никогда не добавляйте реальные токены в репозиторий — указывайте их только в переменных окружения на сервере.

4. Инициализация базы данных происходит автоматически при старте. Для чистого запуска удалите файл `app.db` (если существовал).

5. Запустите бота:

   ```bash
   python -m app.main
   ```

## Настройка Telegram Stars

1. Включите Telegram Stars в настройках вашего бота через @BotFather.
2. Убедитесь, что бот соответствует требованиям Telegram для платежей Stars (провайдер не требуется, `provider_token` оставляется пустым).
3. В `.env` настройте пакеты через `STARS_PACKS`, указав необходимое количество токенов (например, `1,3,5,10`).
4. Пользователь выбирает пакет, оплачивает заказ внутри Telegram, после `successful_payment` токены начисляются автоматически.

## Добавление администратора

- Добавьте ID администратора в переменную `ADMINS` в `.env`.
- После перезапуска бота администратор сможет вызвать `/admin` и открыть панель с кнопками.
- Команда `/health` доступна только администраторам и выводит агрегированную статистику.

## Ручные заявки и администрирование

- Пользователь создаёт заявку через меню «Ручное пополнение», выбирая метод и пакет.
- Заявка получает статус `pending` и отображается администратору в разделе «Заявки».
- В разделе «Пользователи» администратор видит список и может начислять/списывать токены кнопками `+/-` либо указать сумму вручную.
- При подтверждении заявки токены начисляются автоматически. Дополнительно доступна команда `/adjust <user_id> <amount> <reason>`.

## Массовые рассылки

- В админ-панели выберите «Рассылка» и отправьте текст. Сообщение отправится всем зарегистрированным пользователям.

## Экспорт истории операций

- В админ-панели выберите «Экспорт CSV» — бот отправит файл `transactions.csv` с полным логом операций.

## Развёртывание на хостинге

1. Убедитесь, что используется Python 3.11+ и установлены зависимости из `requirements.txt`.
2. Настройте переменные окружения аналогично `.env`.
3. Настройте процесс менеджера (systemd, supervisor, Docker) на запуск команды `python -m app.main`.
4. Обеспечьте перезапуск процесса при сбоях и сохранение логов (stdout/stderr) для мониторинга.

## Структура проекта

```
app/
  main.py              # входная точка бота
  config.py            # конфигурация через pydantic-settings
  db.py                # инициализация и сессии БД
  models.py            # SQLAlchemy модели
  repositories.py      # слой доступа к данным
  services/            # бизнес-логика (billing, stars, admin, users)
  handlers/            # обработчики aiogram
  keyboards/           # клавиатуры и кнопки
  middlewares/         # middleware (админ, анти-флуд)
  utils/               # вспомогательные функции (логирование)
requirements.txt
.env.example
README.md
```

## Полезные команды бота

- `/start` — регистрация и меню.
- `/help` — справка.
- `/buy` — меню покупки токенов с обновлением одного сообщения.
- `/pricing` — справочная информация о ценах.
- `/generate` — демонстрация интеграции генератора изображений.
- `/health` — статус сервиса (только админы).

## Интеграции с внешними сервисами

- Укажите `IMAGE_API_TOKEN`, чтобы включить прогресс-генерацию изображений и заменить заглушку на реальные вызовы API.
- Если сервис генерации работает по webhook, заполните `IMAGE_WEBHOOK_URL` и реализуйте обработчик уведомлений.
- Храните токен криптобота в `CRYPTO_BOT_TOKEN`; дальнейшая бизнес-логика интеграции добавляется в сервисы.

